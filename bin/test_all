#!/usr/bin/env bash

# ECpay Logistics - Multi-version Ruby Test Script
# Tests the gem against multiple Ruby versions

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Ruby versions to test
RUBY_VERSIONS=("2.7.6" "3.0.7" "3.1.7")

# Check if rbenv is installed
if ! command -v rbenv &> /dev/null; then
    echo -e "${RED}Error: rbenv is not installed${NC}"
    echo "Please install rbenv first: https://github.com/rbenv/rbenv"
    exit 1
fi

echo -e "${BLUE}======================================${NC}"
echo -e "${BLUE}ECpay Logistics Multi-Version Testing${NC}"
echo -e "${BLUE}======================================${NC}"
echo ""

# Store results (using simple arrays for bash 3.x compatibility)
results_versions=()
results_status=()
failed_versions=()
passed_versions=()

# Function to store result
store_result() {
    local version=$1
    local status=$2
    results_versions+=("$version")
    results_status+=("$status")
}

# Function to get result
get_result() {
    local version=$1
    for i in "${!results_versions[@]}"; do
        if [ "${results_versions[$i]}" = "$version" ]; then
            echo "${results_status[$i]}"
            return 0
        fi
    done
    echo "UNKNOWN"
}

# Function to test a Ruby version
test_ruby_version() {
    local version=$1
    echo -e "${YELLOW}Testing with Ruby $version...${NC}"
    echo "--------------------------------------"

    # Check if Ruby version is installed
    if ! rbenv versions | grep -q "$version"; then
        echo -e "${RED}Ruby $version is not installed${NC}"
        echo "Installing Ruby $version..."
        rbenv install "$version" || {
            echo -e "${RED}Failed to install Ruby $version${NC}"
            store_result "$version" "INSTALL_FAILED"
            return 1
        }
    fi

    # Set Ruby version
    rbenv local "$version"

    # Verify Ruby version
    current_version=$(ruby -v)
    echo "Current Ruby: $current_version"

    # Install dependencies
    echo "Installing dependencies..."
    if ! bundle install --quiet; then
        echo -e "${RED}Failed to install dependencies for Ruby $version${NC}"
        store_result "$version" "BUNDLE_FAILED"
        return 1
    fi

    # Run tests
    echo "Running tests..."
    if bundle exec rspec --format progress; then
        echo -e "${GREEN}✓ Tests passed for Ruby $version${NC}"
        store_result "$version" "PASSED"
        passed_versions+=("$version")
        return 0
    else
        echo -e "${RED}✗ Tests failed for Ruby $version${NC}"
        store_result "$version" "FAILED"
        failed_versions+=("$version")
        return 1
    fi
}

# Test each Ruby version
for version in "${RUBY_VERSIONS[@]}"; do
    echo ""
    test_ruby_version "$version"
    echo ""
done

# Reset to original Ruby version if .ruby-version exists
if [ -f .ruby-version.bak ]; then
    mv .ruby-version.bak .ruby-version
fi

# Print summary
echo -e "${BLUE}=====================================${NC}"
echo -e "${BLUE}Test Summary${NC}"
echo -e "${BLUE}=====================================${NC}"
echo ""

for version in "${RUBY_VERSIONS[@]}"; do
    result=$(get_result "$version")
    case "$result" in
        "PASSED")
            echo -e "Ruby $version: ${GREEN}✓ PASSED${NC}"
            ;;
        "FAILED")
            echo -e "Ruby $version: ${RED}✗ FAILED${NC}"
            ;;
        "INSTALL_FAILED")
            echo -e "Ruby $version: ${RED}✗ INSTALL FAILED${NC}"
            ;;
        "BUNDLE_FAILED")
            echo -e "Ruby $version: ${RED}✗ BUNDLE FAILED${NC}"
            ;;
        *)
            echo -e "Ruby $version: ${YELLOW}? UNKNOWN${NC}"
            ;;
    esac
done

echo ""
echo -e "Passed: ${GREEN}${#passed_versions[@]}${NC} / ${#RUBY_VERSIONS[@]}"
echo -e "Failed: ${RED}${#failed_versions[@]}${NC} / ${#RUBY_VERSIONS[@]}"
echo ""

# Exit with error if any tests failed
if [ ${#failed_versions[@]} -gt 0 ]; then
    echo -e "${RED}Some tests failed!${NC}"
    exit 1
else
    echo -e "${GREEN}All tests passed!${NC}"
    exit 0
fi
